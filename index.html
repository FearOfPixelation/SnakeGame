<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Game with Skill Tree</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            background-color: #121212;
            color: #ffffff;
        }
        canvas {
            border: 5px solid #ffffff;
        }
        #menu, #skillTree, #settings, #advancedShop, #scoreShop {
            display: none;
            flex-direction: column;
            align-items: center;
        }
        #menu button, #skillTree button, #settings button, #advancedShop button, #scoreShop button {
            margin: 10px;
            padding: 10px;
            font-size: 16px;
            background-color: #333333;
            color: #ffffff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #menu button:hover, #skillTree button:hover, #settings button:hover, #advancedShop button:hover, #scoreShop button:hover {
            background-color: #555555;
        }
        #menu button:disabled, #skillTree button:disabled, #settings button:disabled, #advancedShop button:disabled, #scoreShop button:disabled {
            background-color: #1a1a1a;
            cursor: not-allowed;
        }
        .enabled {
            background-color: green;
            color: white;
        }
        .disabled {
            background-color: red;
            color: white;
        }
        #cooldownDisplay {
            position: absolute;
            bottom: 10px;
            font-size: 16px;
        }
        #popup {
            display: none;
            position: absolute;
            background-color: white;
            border: 2px solid black;
            padding: 20px;
            z-index: 1000;
        }
        #highScore {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 16px;
        }
        #multiplierDisplay {
            position: absolute;
            top: 50px;
            right: 10px;
            font-size: 16px;
        }
        #comboMultiplierDisplay {
            position: absolute;
            top: 90px;
            right: 10px;
            font-size: 16px;
            display: none;
        }
        #comboCountdownDisplay {
            position: absolute;
            top: 130px;
            right: 10px;
            font-size: 16px;
            display: none;
        }
        #scoreCoinsDisplay {
            position: absolute;
            top: 10px;
            right: 200px;
            font-size: 20px;
        }
        #coinEditor {
            display: none;
            position: absolute;
            background-color: white;
            border: 2px solid black;
            padding: 20px;
            z-index: 1000;
        }
        #advancedShop, #scoreShop {
            background-color: purple;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-6gWxzMvUgj4aJngb75Sx1Hj7FL6gFR4TFNT/3pZfQg+8E3/ztAGbcndmRQyZQyzc6F6doePXY5a/PP39S/aBfw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body id="body">
    <canvas id="gameCanvas" width="400" height="400"></canvas>
    <div id="cooldownDisplay"></div>
    <div id="highScore">High Score: <span id="highScoreDisplay">0</span></div>
    <div id="multiplierDisplay">Multiplier: <span id="multiplierValue">1x</span></div>
    <div id="comboMultiplierDisplay">Combo Multiplier: <span id="comboMultiplierValue">1x</span></div>
    <div id="comboCountdownDisplay">Countdown: <span id="comboCountdownValue">2.00</span></div>
    <div id="scoreCoinsDisplay">Score: <span id="scoreDisplay">0</span> | Coins: <span id="coinsDisplay">0</span></div>
    <div id="popup">Hold the Z button to slow down (only works up to 5 seconds)</div>
    <div id="coinEditor">
        <p>Enter the desired amount of coins:</p>
        <input type="number" id="coinInput" value="0">
        <button id="setCoinsButton">Set Coins</button>
        <button id="toggleInvincibilityButton">Toggle Invincibility</button>
        <button id="increaseSpeedButton">Increase Speed</button>
    </div>
    <div id="menu">
        <button id="retryButton"><i class="fas fa-redo"></i> Retry</button>
        <button id="shopButton"><i class="fas fa-cogs"></i> Shop</button>
        <button id="advancedShopButton"><i class="fas fa-store"></i> Advanced Shop (500 coins)</button>
        <button id="scoreShopButton" style="display: none;"><i class="fas fa-chart-line"></i> Score Shop</button>
        <button id="settingsButton"><i class="fas fa-cog"></i> Settings</button>
    </div>
    <div id="skillTree">
        <button id="backToMenuButton"><i class="fas fa-arrow-left"></i> Back to Menu</button>
        <div id="skills">
            <p>Coins: <span id="coinCount">0</span></p>
            <button id="slowDownButton"><i class="fas fa-tachometer-alt"></i> Buy Slow Down (10 coins)</button>
            <button id="biggerMenuButton"><i class="fas fa-expand"></i> Buy Bigger Menu (50 coins) - Remaining: <span id="biggerMenuCount">3</span></button>
            <button id="doubleCoinsButton"><i class="fas fa-coins"></i> Buy Double Coins (100 coins)</button>
            <button id="doubleScoreButton"><i class="fas fa-star"></i> Buy Double Score (100 coins)</button>
            <button id="comboMultiplierButton"><i class="fas fa-star"></i> Buy Combo Multiplier (75 coins)</button>
            <button id="megaAppleButton"><i class="fas fa-apple-alt"></i> Increase the odds of mega apples (50 coins) - Remaining: <span id="megaAppleCount">3</span></button>
        </div>
    </div>
    <div id="advancedShop">
        <button id="backToMenuFromAdvancedShopButton"><i class="fas fa-arrow-left"></i> Back to Menu</button>
        <p>Advanced Shop</p>
        <p>Coins: <span id="advancedCoinCount">0</span></p>
        <button id="extraBiggerMenuButton" disabled><i class="fas fa-expand-arrows-alt"></i> Buy Extra Bigger Menu (150 coins)</button>
        <button id="reduceCooldownButton"><i class="fas fa-hourglass-half"></i> Reduce Cooldown (250 coins)</button>
        <button id="extraCoinMultiplierButton"><i class="fas fa-coins"></i> +1x Multiplier (Next Cost: 100 coins)</button>
        <button id="goldenAppleOddsButton"><i class="fas fa-apple-alt"></i> Increase Golden Apple Odds (Next Cost: 100 coins)</button>
        <button id="sprintButton"><i class="fas fa-running"></i> Buy Sprint Ability (250 coins)</button>
        <button id="comboUpgradeButton"><i class="fas fa-stopwatch"></i> Add 3 Seconds to Combo Duration (300 coins)</button>
        <button id="unlockRainbowApplesButton"><i class="fas fa-apple-alt"></i> Unlock Rainbow Apples (200 coins)</button>
        <button id="tripleScoreButton"><i class="fas fa-star"></i> 3x Score (700 coins)</button>
    </div>
    <div id="scoreShop">
        <button id="backToMenuFromScoreShopButton"><i class="fas fa-arrow-left"></i> Back to Menu</button>
        <p>Score Shop</p>
        <p>Coins: <span id="scoreShopCoinCount">0</span></p>
        <button id="increaseRainbowApplesButton" disabled><i class="fas fa-apple-alt"></i> Increase Rainbow Apple Odds (100 coins)</button>
    </div>
    <div id="settings">
        <button id="backToMenuFromSettingsButton"><i class="fas fa-arrow-left"></i> Back to Menu</button>
        <button id="toggleDarkModeButton" class="enabled"><i class="fas fa-adjust"></i> Toggle Dark/Light Mode</button>
        <button id="toggleSoundEffectsButton" class="enabled"><i class="fas fa-volume-up"></i> Toggle Sound Effects</button>
        <button id="toggleMusicButton" class="enabled"><i class="fas fa-music"></i> Toggle Music</button>
    </div>
    <audio id="deathSound" src="file:///C:/Users/locally/Downloads/fnaf-world-mega-bite.mp3"></audio>
    <audio id="eatSound" src="https://freesound.org/data/previews/270/270304_5123851-lq.mp3"></audio>
    <audio id="backgroundMusic" src="file:///C:/Users/locally/Downloads/videoplayback.m4a" loop></audio>
    <script>
        const body = document.getElementById("body");
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const deathSound = document.getElementById("deathSound");
        const eatSound = document.getElementById("eatSound");
        const backgroundMusic = document.getElementById("backgroundMusic");
        const retryButton = document.getElementById("retryButton");
        const shopButton = document.getElementById("shopButton");
        const advancedShopButton = document.getElementById("advancedShopButton");
        const scoreShopButton = document.getElementById("scoreShopButton");
        const settingsButton = document.getElementById("settingsButton");
        const backToMenuButton = document.getElementById("backToMenuButton");
        const backToMenuFromSettingsButton = document.getElementById("backToMenuFromSettingsButton");
        const backToMenuFromAdvancedShopButton = document.getElementById("backToMenuFromAdvancedShopButton");
        const backToMenuFromScoreShopButton = document.getElementById("backToMenuFromScoreShopButton");
        const toggleDarkModeButton = document.getElementById("toggleDarkModeButton");
        const toggleSoundEffectsButton = document.getElementById("toggleSoundEffectsButton");
        const toggleMusicButton = document.getElementById("toggleMusicButton");
        const slowDownButton = document.getElementById("slowDownButton");
        const biggerMenuButton = document.getElementById("biggerMenuButton");
        const doubleCoinsButton = document.getElementById("doubleCoinsButton");
        const doubleScoreButton = document.getElementById("doubleScoreButton");
        const comboMultiplierButton = document.getElementById("comboMultiplierButton");
        const megaAppleButton = document.getElementById("megaAppleButton");
        const extraBiggerMenuButton = document.getElementById("extraBiggerMenuButton");
        const reduceCooldownButton = document.getElementById("reduceCooldownButton");
        const extraCoinMultiplierButton = document.getElementById("extraCoinMultiplierButton");
        const goldenAppleOddsButton = document.getElementById("goldenAppleOddsButton");
        const sprintButton = document.getElementById("sprintButton");
        const comboUpgradeButton = document.getElementById("comboUpgradeButton");
        const unlockRainbowApplesButton = document.getElementById("unlockRainbowApplesButton");
        const increaseRainbowApplesButton = document.getElementById("increaseRainbowApplesButton");
        const tripleScoreButton = document.getElementById("tripleScoreButton");
        const coinCountDisplay = document.getElementById("coinCount");
        const advancedCoinCountDisplay = document.getElementById("advancedCoinCount");
        const scoreShopCoinCountDisplay = document.getElementById("scoreShopCoinCount");
        const highScoreDisplay = document.getElementById("highScoreDisplay");
        const multiplierDisplay = document.getElementById("multiplierDisplay");
        const multiplierValue = document.getElementById("multiplierValue");
        const comboMultiplierDisplay = document.getElementById("comboMultiplierDisplay");
        const comboMultiplierValue = document.getElementById("comboMultiplierValue");
        const comboCountdownDisplay = document.getElementById("comboCountdownDisplay");
        const comboCountdownValue = document.getElementById("comboCountdownValue");
        const scoreCoinsDisplay = document.getElementById("scoreCoinsDisplay");
        const scoreDisplay = document.getElementById("scoreDisplay");
        const coinsDisplay = document.getElementById("coinsDisplay");
        const biggerMenuCountDisplay = document.getElementById("biggerMenuCount");
        const extraBiggerMenuCountDisplay = document.getElementById("extraBiggerMenuCount");
        const megaAppleCountDisplay = document.getElementById("megaAppleCount");
        const goldenAppleCountDisplay = document.getElementById("goldenAppleCount");
        const menu = document.getElementById("menu");
        const skillTree = document.getElementById("skillTree");
        const settings = document.getElementById("settings");
        const advancedShop = document.getElementById("advancedShop");
        const scoreShop = document.getElementById("scoreShop");
        const cooldownDisplay = document.getElementById("cooldownDisplay");
        const popup = document.getElementById("popup");
        const coinEditor = document.getElementById("coinEditor");
        const coinInput = document.getElementById("coinInput");
        const setCoinsButton = document.getElementById("setCoinsButton");
        const toggleInvincibilityButton = document.getElementById("toggleInvincibilityButton");
        const increaseSpeedButton = document.getElementById("increaseSpeedButton");

        const gridSize = 20;
        let tileCountX = canvas.width / gridSize;
        let tileCountY = canvas.height / gridSize;
        let snake = [{ x: 10, y: 10 }];
        let direction = { x: 0, y: 0 };
        let apple = { x: 15, y: 15, type: "normal" };
        let score = 0;
        let highScore = 0;
        let coins = 0;
        let baseInterval = 100;
        let gameInterval;
        let biggerMenuCount = 3;
        let extraBiggerMenuCount = 1;
        let isSlowDownEnabled = false;
        let slowDownActive = false;
        let isDoubleCoinsEnabled = false;
        let isDoubleScoreEnabled = false;
        let isTripleScoreEnabled = false;
        let isExtraCoinMultiplierEnabled = false;
        let isSprintEnabled = false;
        let sprintActive = false;
        let isComboMultiplierEnabled = false;
        let comboPurchaseCount = 0;
        let comboMultiplierCost = 75;
        let comboDuration = 2.00;
        let isComboUpgradePurchased = false;
        let isRainbowApplesUnlocked = false;
        let rainbowAppleRate = 0;
        let rainbowAppleOddsCost = [100, 200, 300];
        let rainbowAppleOddsCount = 0;
        let megaAppleCount = 0;
        let megaAppleRate = 0.05;
        let goldenAppleCount = 0;
        let goldenAppleRate = 0.00;
        let darkMode = true;
        let soundEffectsEnabled = true;
        let musicEnabled = true;
        let slowDownCooldown = false;
        let cooldownTime = 0;
        let advancedShopPurchased = false;
        let extraCoinMultiplierCount = 0;
        let extraCoinMultiplierCost = [100, 250, 300, 450, 600, 650, 750, 1000, 1250, 1500];
        let goldenAppleOddsCount = 0;
        let goldenAppleOddsCost = [100, 250, 300];
        let comboMultiplier = 1;
        let comboTimeout;
        let comboCountdown = comboDuration;
        let comboCountdownInterval;
        let keysPressed = {
            shift: false,
            q: false,
            e: false,
            up: false,
            down: false,
            left: false,
            right: false
        };
        let invincibility = false;
        let rainbowAppleColors = ["red", "orange", "yellow", "green", "blue", "indigo", "violet"];

        function gameLoop() {
            update();
            draw();
        }

        function update() {
            const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };

            if (head.x === apple.x && head.y === apple.y) {
                let baseCoinMultiplier = score >= 1000 ? 8.5 : score >= 800 ? 5 : score >= 400 ? 4 : score >= 200 ? 3 : score >= 100 ? 2.5 : score >= 70 ? 2 : score >= 40 ? 1.5 : score >= 20 ? 1.25 : 1;
                let coinMultiplier = (isDoubleCoinsEnabled ? 2 : 0) + (isExtraCoinMultiplierEnabled ? extraCoinMultiplierCount : 0) + baseCoinMultiplier;
                let scoreMultiplier = (isDoubleScoreEnabled ? 2 : 0) + (isTripleScoreEnabled ? 3 : 0) + 1;

                if (apple.type === "normal") {
                    score += 1 * scoreMultiplier * comboMultiplier;
                    coins += 1 * coinMultiplier * comboMultiplier;
                } else if (apple.type === "mega") {
                    score += 5 * scoreMultiplier * comboMultiplier;
                    coins += 10 * coinMultiplier * comboMultiplier;
                } else if (apple.type === "golden") {
                    score += 10 * scoreMultiplier * comboMultiplier;
                    coins += 50 * coinMultiplier * comboMultiplier;
                } else if (apple.type === "rainbow") {
                    score += 100 * scoreMultiplier * comboMultiplier;
                    coins += 100 * coinMultiplier * comboMultiplier;
                }
                if (soundEffectsEnabled) playSound(eatSound);
                spawnApple();

                // Handle combo multiplier
                if (isComboMultiplierEnabled) {
                    clearTimeout(comboTimeout);
                    clearInterval(comboCountdownInterval);
                    comboMultiplier = Math.min(comboMultiplier + 1, 6); // Max combo multiplier is 6x
                    comboCountdown = comboDuration;
                    comboCountdownInterval = setInterval(updateComboCountdown, 10);
                    comboTimeout = setTimeout(() => {
                        comboMultiplier = 1;
                        clearInterval(comboCountdownInterval);
                        comboCountdown = comboDuration;
                        updateComboCountdownDisplay();
                    }, comboDuration * 1000); // Reset combo if no apple eaten in combo duration
                }
            } else {
                snake.pop();
            }

            if (!invincibility && (head.x < 0 || head.x >= tileCountX || head.y < 0 || head.y >= tileCountY || snake.some(segment => segment.x === head.x && segment.y === head.y))) {
                if (soundEffectsEnabled) playSound(deathSound);
                clearInterval(gameInterval);
                clearInterval(comboCountdownInterval);
                if (score > highScore) {
                    highScore = score;
                    highScoreDisplay.textContent = highScore;
                }
                displayMenu();
                return;
            }

            snake.unshift(head);
            updateScoreAndCoinsDisplay();
            updateMultiplierDisplay();
            updateButtonStates();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            let snakeColor = "green";
            let baseCoinMultiplier = 1;
            if (score >= 1000) {
                baseCoinMultiplier = 8.5;
                snakeColor = darkMode ? "white" : "black";
            } else if (score >= 800) {
                baseCoinMultiplier = 5;
                snakeColor = darkMode ? "white" : "black";
            } else if (score >= 400) {
                baseCoinMultiplier = 4;
                snakeColor = darkMode ? "white" : "black";
            } else if (score >= 200) {
                baseCoinMultiplier = 3;
                snakeColor = darkMode ? "white" : "black";
            } else if (score >= 100) {
                baseCoinMultiplier = 2.5;
                snakeColor = darkMode ? "white" : "black";
            } else if (score >= 70) {
                baseCoinMultiplier = 2;
                snakeColor = darkMode ? "white" : "black";
            } else if (score >= 40) {
                baseCoinMultiplier = 1.5;
                snakeColor = "orange";
            } else if (score >= 20) {
                baseCoinMultiplier = 1.25;
                snakeColor = "blue";
            }

            snake.forEach(segment => {
                ctx.fillStyle = snakeColor;
                ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 2, gridSize - 2);
            });

            if (apple.type === "normal") {
                ctx.fillStyle = "red";
            } else if (apple.type === "mega") {
                ctx.fillStyle = "purple";
            } else if (apple.type === "golden") {
                ctx.fillStyle = "gold";
            } else if (apple.type === "rainbow") {
                ctx.fillStyle = getRandomRainbowColor();
            }
            ctx.fillRect(apple.x * gridSize, apple.y * gridSize, gridSize - 2, gridSize - 2);

            ctx.fillStyle = darkMode ? "white" : "black";
        }

        function getRandomRainbowColor() {
            return rainbowAppleColors[Math.floor(Math.random() * rainbowAppleColors.length)];
        }

        function changeDirection() {
            if (keysPressed.up && direction.y === 0) {
                direction = { x: 0, y: -1 };
            } else if (keysPressed.down && direction.y === 0) {
                direction = { x: 0, y: 1 };
            } else if (keysPressed.left && direction.x === 0) {
                direction = { x: -1, y: 0 };
            } else if (keysPressed.right && direction.x === 0) {
                direction = { x: 1, y: 0 };
            }
        }

        function stopSprint(event) {
            if ((event.key === "x" || event.key === "X") && sprintActive) {
                sprintActive = false;
                clearInterval(gameInterval);
                gameInterval = setInterval(gameLoop, baseInterval);
            }
            delete keysPressed[event.key];
        }

        function resetGame() {
            snake = [{ x: 10, y: 10 }];
            direction = { x: 0, y: 0 };
            spawnApple();
            score = 0;
            comboMultiplier = 1;
            comboCountdown = comboDuration;
            updateComboCountdownDisplay();
            updateMultiplierDisplay(); // Update multiplier before the game starts
            updateScoreAndCoinsDisplay(); // Update score and coins before the game starts
            clearInterval(gameInterval);  // Clear any existing intervals
            clearInterval(comboCountdownInterval); // Clear the combo countdown interval
            gameInterval = setInterval(gameLoop, baseInterval);
            // Start background music
            if (musicEnabled) {
                backgroundMusic.play().catch(error => {
                    console.log("Music autoplay prevented. Waiting for user interaction to start.", error);
                });
            }
            scoreCoinsDisplay.style.display = 'block'; // Show the score and coins display
            updateButtonStates(); // Update button states when the game resets
            updateStatsRegularly(); // Update stats every few seconds
        }

        function spawnApple() {
            const rand = Math.random();
            if (rand < rainbowAppleRate) {
                apple = { x: Math.floor(Math.random() * tileCountX), y: Math.floor(Math.random() * tileCountY), type: "rainbow" };
            } else if (rand < goldenAppleRate + rainbowAppleRate) {
                apple = { x: Math.floor(Math.random() * tileCountX), y: Math.floor(Math.random() * tileCountY), type: "golden" };
            } else if (rand < megaAppleRate + goldenAppleRate + rainbowAppleRate) {
                apple = { x: Math.floor(Math.random() * tileCountX), y: Math.floor(Math.random() * tileCountY), type: "mega" };
            } else {
                apple = { x: Math.floor(Math.random() * tileCountX), y: Math.floor(Math.random() * tileCountY), type: "normal" };
            }
        }

        function displayMenu() {
            menu.style.display = 'flex';
            skillTree.style.display = 'none';
            settings.style.display = 'none';
            advancedShop.style.display = 'none';
            scoreShop.style.display = 'none';
            canvas.style.display = 'none';
            updateCoinCount();
            updateMultiplierDisplay(); // Update multiplier after the game ends
            scoreCoinsDisplay.style.display = 'none'; // Hide the score and coins display
        }

        function hideMenu() {
            menu.style.display = 'none';
            skillTree.style.display = 'none';
            settings.style.display = 'none';
            advancedShop.style.display = 'none';
            scoreShop.style.display = 'none';
            canvas.style.display = 'block';
        }

        function displaySkillTree() {
            skillTree.style.display = 'flex';
            menu.style.display = 'none';
            updateCoinCount();
            updateButtonStates();
        }

        function displaySettings() {
            settings.style.display = 'flex';
            menu.style.display = 'none';
        }

        function displayAdvancedShop() {
            if (!advancedShopPurchased && coins >= 500) {
                coins -= 500;
                advancedShopPurchased = true;
                updateCoinCount();
                advancedShopButton.textContent = "Advanced Shop";
            }
            if (advancedShopPurchased) {
                advancedShop.style.display = 'flex';
                menu.style.display = 'none';
            } else {
                alert("Not enough coins to access the Advanced Shop!");
            }
            updateButtonStates();
        }

        function displayScoreShop() {
            if (score >= 100) {
                scoreShop.style.display = 'flex';
                menu.style.display = 'none';
                scoreShopCoinCountDisplay.textContent = coins;
            } else {
                alert("Score at least 100 to access the Score Shop!");
            }
        }

        function toggleDarkMode() {
            darkMode = !darkMode;
            body.style.backgroundColor = darkMode ? "#121212" : "#f0f0f0";
            body.style.color = darkMode ? "#ffffff" : "#000000";
            canvas.style.borderColor = darkMode ? "#ffffff" : "#000000";
            popup.style.color = darkMode ? "#121212" : "#f0f0f0"; // Fix popup text color
            scoreCoinsDisplay.style.color = darkMode ? "#ffffff" : "#000000"; // Fix score and coins text color
            cooldownDisplay.style.color = darkMode ? "#ffffff" : "#000000"; // Fix debug text color
        }

        function toggleSoundEffects() {
            soundEffectsEnabled = !soundEffectsEnabled;
            toggleSoundEffectsButton.className = soundEffectsEnabled ? "enabled" : "disabled";
        }

        function toggleMusic() {
            musicEnabled = !musicEnabled;
            toggleMusicButton.className = musicEnabled ? "enabled" : "disabled";
            if (musicEnabled) {
                backgroundMusic.play();
            } else {
                backgroundMusic.pause();
            }
        }

        function playSound(sound) {
            sound.currentTime = 0;
            sound.play();
        }

        function updateComboCountdown() {
            comboCountdown -= 0.01;
            if (comboCountdown <= 0) {
                comboMultiplier = 1;
                comboCountdown = comboDuration;
                clearInterval(comboCountdownInterval);
            }
            updateComboCountdownDisplay();
        }

        function updateComboCountdownDisplay() {
            comboCountdownValue.textContent = comboCountdown.toFixed(2);
        }

        function updateMultiplierDisplay() {
            let baseCoinMultiplier = score >= 1000 ? 8.5 : score >= 800 ? 5 : score >= 400 ? 4 : score >= 200 ? 3 : score >= 100 ? 2.5 : score >= 70 ? 2 : score >= 40 ? 1.5 : score >= 20 ? 1.25 : 1;
            let totalMultiplier = baseCoinMultiplier + (isDoubleCoinsEnabled ? 2 : 0) + (isExtraCoinMultiplierEnabled ? extraCoinMultiplierCount : 0);
            multiplierValue.textContent = totalMultiplier.toFixed(2) + 'x';
            comboMultiplierValue.textContent = comboMultiplier.toFixed(2) + 'x';
        }

        function updateScoreAndCoinsDisplay() {
            scoreDisplay.textContent = score;
            coinsDisplay.textContent = coins;
            if (score >= 100) {
                scoreShopButton.style.display = 'inline-block';
            }
        }

        function updateButtonStates() {
            slowDownButton.disabled = coins < 10 || isSlowDownEnabled;
            slowDownButton.className = slowDownButton.disabled ? "disabled" : "";

            biggerMenuButton.disabled = coins < 50 || biggerMenuCount <= 0;
            biggerMenuButton.className = biggerMenuButton.disabled ? "disabled" : "";

            doubleCoinsButton.disabled = coins < 100 || isDoubleCoinsEnabled;
            doubleCoinsButton.className = doubleCoinsButton.disabled ? "disabled" : "";

            doubleScoreButton.disabled = coins < 100 || isDoubleScoreEnabled;
            doubleScoreButton.className = doubleScoreButton.disabled ? "disabled" : "";

            comboMultiplierButton.disabled = coins < comboMultiplierCost || comboPurchaseCount >= 3;
            comboMultiplierButton.className = comboMultiplierButton.disabled ? "disabled" : "";

            megaAppleButton.disabled = coins < 50 || megaAppleCount >= 3;
            megaAppleButton.className = megaAppleButton.disabled ? "disabled" : "";

            extraBiggerMenuButton.disabled = coins < 150 || extraBiggerMenuCount <= 0;
            extraBiggerMenuButton.className = extraBiggerMenuButton.disabled ? "disabled" : "";

            reduceCooldownButton.disabled = coins < 250 || cooldownTime > 0;
            reduceCooldownButton.className = reduceCooldownButton.disabled ? "disabled" : "";

            extraCoinMultiplierButton.disabled = coins < extraCoinMultiplierCost[extraCoinMultiplierCount] || extraCoinMultiplierCount >= 10;
            extraCoinMultiplierButton.className = extraCoinMultiplierButton.disabled ? "disabled" : "";

            goldenAppleOddsButton.disabled = coins < goldenAppleOddsCost[goldenAppleOddsCount] || goldenAppleOddsCount >= 3;
            goldenAppleOddsButton.className = goldenAppleOddsButton.disabled ? "disabled" : "";

            sprintButton.disabled = coins < 250 || isSprintEnabled;
            sprintButton.className = sprintButton.disabled ? "disabled" : "";

            comboUpgradeButton.disabled = coins < 300 || isComboUpgradePurchased;
            comboUpgradeButton.className = comboUpgradeButton.disabled ? "disabled" : "";

            unlockRainbowApplesButton.disabled = coins < 200 || isRainbowApplesUnlocked;
            unlockRainbowApplesButton.className = unlockRainbowApplesButton.disabled ? "disabled" : "";

            increaseRainbowApplesButton.disabled = coins < rainbowAppleOddsCost[rainbowAppleOddsCount] || !isRainbowApplesUnlocked || rainbowAppleOddsCount >= 3;
            increaseRainbowApplesButton.className = increaseRainbowApplesButton.disabled ? "disabled" : "";

            tripleScoreButton.disabled = coins < 700 || isTripleScoreEnabled;
            tripleScoreButton.className = tripleScoreButton.disabled ? "disabled" : "";

            advancedShopButton.disabled = coins < 500 && !advancedShopPurchased;
            advancedShopButton.className = advancedShopButton.disabled ? "disabled" : "";
        }

        function updateStatsRegularly() {
            setInterval(() => {
                updateMultiplierDisplay();
                updateComboCountdownDisplay();
                updateScoreAndCoinsDisplay();
                updateButtonStates();
            }, 1000);
        }

        retryButton.addEventListener("click", () => {
            resetGame();
            hideMenu();
        });

        shopButton.addEventListener("click", displaySkillTree);

        settingsButton.addEventListener("click", displaySettings);

        advancedShopButton.addEventListener("click", displayAdvancedShop);

        scoreShopButton.addEventListener("click", displayScoreShop);

        backToMenuButton.addEventListener("click", displayMenu);

        backToMenuFromSettingsButton.addEventListener("click", displayMenu);

        backToMenuFromAdvancedShopButton.addEventListener("click", displayMenu);

        backToMenuFromScoreShopButton.addEventListener("click", displayMenu);

        toggleDarkModeButton.addEventListener("click", toggleDarkMode);

        toggleSoundEffectsButton.addEventListener("click", toggleSoundEffects);

        toggleMusicButton.addEventListener("click", toggleMusic);

        slowDownButton.addEventListener("click", () => {
            if (coins >= 10) {
                coins -= 10;
                isSlowDownEnabled = true;
                slowDownButton.disabled = true;
                updateCoinCount();
                popup.style.display = "block";
                setTimeout(() => {
                    popup.style.display = "none";
                }, 3000);
            }
        });

        biggerMenuButton.addEventListener("click", () => {
            if (coins >= 50 && biggerMenuCount > 0) {
                coins -= 50;
                biggerMenuCount--;
                canvas.width += 100;
                canvas.height += 100;
                tileCountX = canvas.width / gridSize;
                tileCountY = canvas.height / gridSize;
                updateCoinCount();
                biggerMenuCountDisplay.textContent = biggerMenuCount;
                if (biggerMenuCount === 0) {
                    biggerMenuButton.disabled = true;
                }
            }
        });

        extraBiggerMenuButton.addEventListener("click", () => {
            if (coins >= 150 && extraBiggerMenuCount > 0) {
                coins -= 150;
                extraBiggerMenuCount--;
                canvas.width += 100;
                canvas.height += 100;
                tileCountX = canvas.width / gridSize;
                tileCountY = canvas.height / gridSize;
                updateCoinCount();
                extraBiggerMenuCountDisplay.textContent = extraBiggerMenuCount;
                if (extraBiggerMenuCount === 0) {
                    extraBiggerMenuButton.disabled = true;
                }
            }
        });

        doubleCoinsButton.addEventListener("click", () => {
            if (coins >= 100) {
                coins -= 100;
                isDoubleCoinsEnabled = true;
                doubleCoinsButton.disabled = true;
                updateCoinCount();
            }
        });

        doubleScoreButton.addEventListener("click", () => {
            if (coins >= 100) {
                coins -= 100;
                isDoubleScoreEnabled = true;
                doubleScoreButton.disabled = true;
                updateCoinCount();
            }
        });

        comboMultiplierButton.addEventListener("click", () => {
            if (coins >= comboMultiplierCost && comboPurchaseCount < 3) {
                coins -= comboMultiplierCost;
                comboMultiplierCost += 50;
                comboPurchaseCount++;
                isComboMultiplierEnabled = true;
                if (comboPurchaseCount === 1) {
                    comboMultiplierButton.textContent = "Increase Combo Duration (Next Cost: " + comboMultiplierCost + " coins)";
                    comboMultiplierDisplay.style.display = "block";
                    comboCountdownDisplay.style.display = "block";
                } else if (comboPurchaseCount === 2) {
                    comboDuration += 1;
                    comboMultiplierButton.textContent = "Increase Combo Duration (Next Cost: " + comboMultiplierCost + " coins)";
                } else if (comboPurchaseCount === 3) {
                    comboDuration += 1;
                    comboMultiplierButton.disabled = true;
                    comboMultiplierButton.textContent = "Max Combo Multiplier";
                }
                updateCoinCount();
            }
        });

        comboUpgradeButton.addEventListener("click", () => {
            if (coins >= 300) {
                coins -= 300;
                comboDuration += 3;
                isComboUpgradePurchased = true;
                comboUpgradeButton.disabled = true;
                comboUpgradeButton.textContent = "Combo Duration Upgraded";
                updateCoinCount();
            }
        });

        unlockRainbowApplesButton.addEventListener("click", () => {
            if (coins >= 200) {
                coins -= 200;
                isRainbowApplesUnlocked = true;
                unlockRainbowApplesButton.disabled = true;
                unlockRainbowApplesButton.textContent = "Rainbow Apples Unlocked";
                updateCoinCount();
            }
        });

        increaseRainbowApplesButton.addEventListener("click", () => {
            if (coins >= rainbowAppleOddsCost[rainbowAppleOddsCount] && rainbowAppleOddsCount < 3 && isRainbowApplesUnlocked) {
                coins -= rainbowAppleOddsCost[rainbowAppleOddsCount];
                rainbowAppleOddsCount++;
                rainbowAppleRate = rainbowAppleOddsCount === 1 ? 0.03 : rainbowAppleOddsCount === 2 ? 0.06 : 0.09;
                updateCoinCount();
                if (rainbowAppleOddsCount < 3) {
                    increaseRainbowApplesButton.textContent = "Increase Rainbow Apple Odds (Next Cost: " + rainbowAppleOddsCost[rainbowAppleOddsCount] + " coins)";
                } else {
                    increaseRainbowApplesButton.disabled = true;
                    increaseRainbowApplesButton.textContent = "Max Rainbow Apple Odds";
                }
            }
        });

        tripleScoreButton.addEventListener("click", () => {
            if (coins >= 700) {
                coins -= 700;
                isTripleScoreEnabled = true;
                tripleScoreButton.disabled = true;
                updateCoinCount();
            }
        });

        megaAppleButton.addEventListener("click", () => {
            if (coins >= 50 && megaAppleCount < 3) {
                coins -= 50;
                megaAppleCount++;
                megaAppleRate = megaAppleCount === 1 ? 0.15 : megaAppleCount === 2 ? 0.20 : 0.272;
                goldenAppleRate = megaAppleCount === 1 ? 0.01 : megaAppleCount === 2 ? 0.03 : 0.03;
                updateCoinCount();
                megaAppleCountDisplay.textContent = 3 - megaAppleCount;
                if (megaAppleCount === 3) {
                    megaAppleButton.disabled = true;
                }
            }
        });

        reduceCooldownButton.addEventListener("click", () => {
            if (coins >= 250) {
                coins -= 250;
                cooldownTime = 10000; // 10 seconds cooldown
                reduceCooldownButton.disabled = true;
                updateCoinCount();
            }
        });

        extraCoinMultiplierButton.addEventListener("click", () => {
            if (coins >= extraCoinMultiplierCost[extraCoinMultiplierCount] && extraCoinMultiplierCount < 10) {
                coins -= extraCoinMultiplierCost[extraCoinMultiplierCount];
                extraCoinMultiplierCount++;
                isExtraCoinMultiplierEnabled = true;
                if (extraCoinMultiplierCount < 10) {
                    extraCoinMultiplierButton.textContent = "+1x Multiplier (Next Cost: " + extraCoinMultiplierCost[extraCoinMultiplierCount] + " coins)";
                } else {
                    extraCoinMultiplierButton.disabled = true;
                    extraCoinMultiplierButton.textContent = "Max +1x Multiplier";
                }
                updateCoinCount();
                updateMultiplierDisplay();
            }
        });

        goldenAppleOddsButton.addEventListener("click", () => {
            if (coins >= goldenAppleOddsCost[goldenAppleOddsCount] && goldenAppleOddsCount < 3) {
                coins -= goldenAppleOddsCost[goldenAppleOddsCount];
                goldenAppleOddsCount++;
                goldenAppleRate = goldenAppleCount === 1 ? 0.03 : goldenAppleCount === 2 ? 0.06 : 0.09;
                updateCoinCount();
                if (goldenAppleOddsCount < 3) {
                    goldenAppleOddsButton.textContent = "Increase Golden Apple Odds (Next Cost: " + goldenAppleOddsCost[goldenAppleOddsCount] + " coins)";
                } else {
                    goldenAppleOddsButton.disabled = true;
                    goldenAppleOddsButton.textContent = "Max Golden Apple Odds";
                }
            }
        });

        sprintButton.addEventListener("click", () => {
            if (coins >= 250) {
                coins -= 250;
                isSprintEnabled = true;
                sprintButton.disabled = true;
                updateCoinCount();
            }
        });

        setCoinsButton.addEventListener("click", () => {
            coins = parseInt(coinInput.value, 10);
            updateCoinCount();
            updateButtonStates();
            coinEditor.style.display = 'none';
        });

        toggleInvincibilityButton.addEventListener("click", () => {
            invincibility = !invincibility;
            toggleInvincibilityButton.textContent = invincibility ? "Disable Invincibility" : "Enable Invincibility";
        });

        increaseSpeedButton.addEventListener("click", () => {
            baseInterval = Math.max(10, baseInterval - 10);
            clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, baseInterval);
        });

        function updateCoinCount() {
            coinCountDisplay.textContent = coins;
            advancedCoinCountDisplay.textContent = coins;
            scoreShopCoinCountDisplay.textContent = coins;
            updateButtonStates();
        }

        document.addEventListener("keydown", (event) => {
            switch (event.key) {
                case "Shift":
                    keysPressed.shift = true;
                    break;
                case "Q":
                    if (keysPressed.shift) keysPressed.q = true;
                    break;
                case "E":
                    if (keysPressed.q) keysPressed.e = true;
                    break;
                case "ArrowUp":
                    keysPressed.up = true;
                    break;
                case "ArrowDown":
                    keysPressed.down = true;
                    break;
                case "ArrowLeft":
                    keysPressed.left = true;
                    break;
                case "ArrowRight":
                    keysPressed.right = true;
                    break;
                case "z":
                case "Z":
                    if (isSlowDownEnabled && !slowDownActive && !slowDownCooldown) {
                        slowDownActive = true;
                        clearInterval(gameInterval);
                        gameInterval = setInterval(gameLoop, baseInterval * 1.5);
                        setTimeout(() => {
                            slowDownActive = false;
                            slowDownCooldown = true;
                            cooldownTime = 20000; // 20 seconds cooldown
                            clearInterval(gameInterval);
                            gameInterval = setInterval(gameLoop, baseInterval);
                            const cooldownInterval = setInterval(() => {
                                cooldownTime -= 1000;
                                if (cooldownTime <= 0) {
                                    slowDownCooldown = false;
                                    clearInterval(cooldownInterval);
                                }
                            }, 1000);
                        }, 5000); // 5 seconds duration
                    }
                    break;
                case "x":
                case "X":
                    if (isSprintEnabled) {
                        sprintActive = true;
                        clearInterval(gameInterval);
                        gameInterval = setInterval(gameLoop, baseInterval / 2);
                    }
                    break;
            }
            if (keysPressed.shift && keysPressed.q && keysPressed.e) {
                coinEditor.style.display = 'block';
            }
            changeDirection();
        });

        document.addEventListener("keyup", (event) => {
            switch (event.key) {
                case "Shift":
                    keysPressed.shift = false;
                    keysPressed.q = false;
                    keysPressed.e = false;
                    break;
                case "Q":
                    keysPressed.q = false;
                    break;
                case "E":
                    keysPressed.e = false;
                    break;
                case "ArrowUp":
                    keysPressed.up = false;
                    break;
                case "ArrowDown":
                    keysPressed.down = false;
                    break;
                case "ArrowLeft":
                    keysPressed.left = false;
                    break;
                case "ArrowRight":
                    keysPressed.right = false;
                    break;
                case "x":
                case "X":
                    stopSprint(event);
                    break;
            }
            changeDirection();
        });

        // Start background music when the document is loaded
        document.addEventListener("DOMContentLoaded", () => {
            if (musicEnabled) {
                backgroundMusic.play().catch(error => {
                    console.log("Music autoplay prevented. Waiting for user interaction to start.", error);
                });
            }
        });

        canvas.addEventListener("touchstart", handleTouch, false);
        canvas.addEventListener("touchmove", handleTouch, false);

        function handleTouch(event) {
            const touch = event.touches[0];
            const rect = canvas.getBoundingClientRect();
            const touchX = touch.clientX - rect.left;
            const touchY = touch.clientY - rect.top;

            const snakeHead = snake[0];
            const headX = snakeHead.x * gridSize + gridSize / 2;
            const headY = snakeHead.y * gridSize + gridSize / 2;

            const dx = touchX - headX;
            const dy = touchY - headY;

            if (Math.abs(dx) > Math.abs(dy)) {
                if (dx > 0 && direction.x === 0) {
                    direction = { x: 1, y: 0 };
                } else if (dx < 0 && direction.x === 0) {
                    direction = { x: -1, y: 0 };
                }
            } else {
                if (dy > 0 && direction.y === 0) {
                    direction = { x: 0, y: 1 };
                } else if (dy < 0 && direction.y === 0) {
                    direction = { x: 0, y: -1 };
                }
            }

            if (snake.length > 1 && direction.x === -snake[1].x && direction.y === -snake[1].y) {
                return;
            }

            event.preventDefault();
        }

        resetGame();
    </script>
</body>
</html>
