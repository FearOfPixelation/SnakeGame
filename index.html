<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Game with Skill Tree</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            background-color: #121212;
            color: #ffffff;
        }
        canvas {
            border: 5px solid #ffffff;
        }
        #menu, #skillTree, #settings, #advancedShop, #scoreShop, #inventory { /* Added #inventory */
            display: none;
            flex-direction: column;
            align-items: center;
        }
        #menu button, #skillTree button, #settings button, #advancedShop button, #scoreShop button, #inventory button { /* Added #inventory */
            margin: 10px;
            padding: 10px;
            font-size: 16px;
            background-color: #333333;
            color: #ffffff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #menu button:hover, #skillTree button:hover, #settings button:hover, #advancedShop button:hover, #scoreShop button:hover, #inventory button:hover { /* Added #inventory */
            background-color: #555555;
        }
        #menu button:disabled, #skillTree button:disabled, #settings button:disabled, #advancedShop button:disabled, #scoreShop button:disabled, #inventory button:disabled { /* Added #inventory */
            background-color: #1a1a1a;
            cursor: not-allowed;
        }
        .enabled {
            background-color: green;
            color: white;
        }
        .disabled {
            background-color: red;
            color: white;
        }
        #cooldownDisplay {
            position: absolute;
            bottom: 10px;
            font-size: 16px;
        }
        #popup, #rebirthPopup {
            display: none;
            position: absolute;
            background-color: white;
            border: 2px solid black;
            padding: 20px;
            z-index: 1000;
            color: black;
        }
        #popup .ok-button, #rebirthPopup .ok-button {
            margin-top: 10px;
            padding: 5px;
            background-color: #333333;
            color: #ffffff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        #rebirthPopup {
            background-color: #808080;
        }
        #highScore, #multiplierDisplay, #scoreCoinMultiplierDisplay, #comboMultiplierDisplay, #comboCountdownDisplay, #sizeDisplay, #highSizeDisplay, #scoreCoinsDisplay {
            position: absolute;
            font-size: 16px;
        }
        #highScore {
            top: 10px;
            right: 10px;
        }
        #multiplierDisplay {
            top: 30px;
            right: 10px;
        }
        #scoreCoinMultiplierDisplay {
            top: 50px;
            right: 10px;
        }
        #comboMultiplierDisplay {
            top: 70px;
            right: 10px;
            display: none;
        }
        #comboCountdownDisplay {
            top: 90px;
            right: 10px;
            display: none;
        }
        #sizeDisplay {
            top: 110px;
            right: 10px;
        }
        #highSizeDisplay {
            top: 130px;
            right: 10px;
        }
        #scoreCoinsDisplay {
            top: 150px;
            right: 10px;
            font-size: 20px;
        }
        #coinEditor {
            display: none;
            position: absolute;
            background-color: white;
            border: 2px solid black;
            padding: 20px;
            z-index: 1000;
            color: black;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-6gWxzMvUgj4aJngb75Sx1Hj7FL6gFR4TFNT/3pZfQg+8E3/ztAGbcndmRQyZQyzc6F6doePXY5a/PP39S/aBfw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body id="body">
    <canvas id="gameCanvas" width="400" height="400"></canvas>
    <div id="cooldownDisplay"></div>
    <div id="highScore">High Score: <span id="highScoreDisplay">0</span></div>
    <div id="multiplierDisplay">Multiplier: <span id="multiplierValue">1x</span></div>
    <div id="scoreCoinMultiplierDisplay">Score Coin Multiplier: <span id="scoreCoinMultiplierValue">1x</span></div>
    <div id="comboMultiplierDisplay">Combo Multiplier: <span id="comboMultiplierValue">1x</span></div>
    <div id="comboCountdownDisplay">Countdown: <span id="comboCountdownValue">2.00</span></div>
    <div id="sizeDisplay">Size: <span id="sizeValue">1</span></div>
    <div id="highSizeDisplay">High Size Score: <span id="highSizeValue">1</span></div>
    <div id="scoreCoinsDisplay">Score: <span id="scoreDisplay">0</span> | Coins: <span id="coinsDisplay">0</span></div>
    <div id="popup">
        <p id="popupText"></p>
        <button id="popupOkButton" class="ok-button">OK</button>
    </div>
    <div id="rebirthPopup">
        <p id="rebirthPopupText">You have rebirthed!</p>
        <ul>
            <li>All progress has reset</li>
            <li>You have unlocked crafting</li>
            <li>Your coins have doubled</li>
        </ul>
        <button id="rebirthPopupOkButton" class="ok-button">OKAY</button>
    </div>
    <div id="coinEditor">
        <p>Enter the desired amount of coins:</p>
        <input type="number" id="coinInput" value="0">
        <button id="setCoinsButton">Set Coins</button>
        <button id="toggleInvincibilityButton">Toggle Invincibility</button>
        <button id="increaseSpeedButton">Increase Speed</button>
    </div>
    <div id="menu">
        <button id="retryButton"><i class="fas fa-redo"></i> Retry</button>
        <button id="shopButton"><i class="fas fa-cogs"></i> Shop</button>
        <button id="advancedShopButton"><i class="fas fa-store"></i> Advanced Shop (500 coins)</button>
        <button id="scoreShopButton" style="display: none;"><i class="fas fa-chart-line"></i> Score Shop</button>
        <button id="rebirthButton" style="display: none;"><i class="fas fa-redo-alt"></i> Rebirth (500,000 coins)</button>
        <button id="settingsButton"><i class="fas fa-cog"></i> Settings</button>
        <button id="inventoryButton" style="display: none;"><i class="fas fa-box"></i> Inventory</button> <!-- New Inventory Button -->
    </div>
    <div id="skillTree">
        <button id="backToMenuButton"><i class="fas fa-arrow-left"></i> Back to Menu</button>
        <div id="skills">
            <p>Coins: <span id="coinCount">0</span></p>
            <button id="slowDownButton"><i class="fas fa-tachometer-alt"></i> Buy Slow Down (10 coins)</button>
            <button id="biggerMenuButton"><i class="fas fa-expand"></i> Buy Bigger Menu (50 coins) - Remaining: <span id="biggerMenuCount">3</span></button>
            <button id="doubleCoinsButton"><i class="fas fa-coins"></i> Buy Double Coins (100 coins)</button>
            <button id="doubleScoreButton"><i class="fas fa-star"></i> Buy Double Score (100 coins)</button>
            <button id="comboMultiplierButton"><i class="fas fa-star"></i> Buy Combo Multiplier (75 coins)</button>
            <button id="megaAppleButton"><i class="fas fa-apple-alt"></i> Increase the odds of mega apples (50 coins) - Remaining: <span id="megaAppleCount">3</span></button>
        </div>
    </div>
    <div id="advancedShop">
        <button id="backToMenuFromAdvancedShopButton"><i class="fas fa-arrow-left"></i> Back to Menu</button>
        <p>Advanced Shop</p>
        <p>Coins: <span id="advancedCoinCount">0</span></p>
        <button id="extraBiggerMenuButton" disabled><i class="fas fa-expand-arrows-alt"></i> Buy Extra Bigger Menu (150 coins)</button>
        <button id="reduceCooldownButton"><i class="fas fa-hourglass-half"></i> Reduce Cooldown (250 coins)</button>
        <button id="extraCoinMultiplierButton"><i class="fas fa-coins"></i> +1x Multiplier (Next Cost: 100 coins)</button>
        <button id="goldenAppleOddsButton"><i class="fas fa-apple-alt"></i> Increase Golden Apple Odds (Next Cost: 100 coins)</button>
        <button id="sprintButton"><i class="fas fa-running"></i> Buy Sprint Ability (250 coins)</button>
        <button id="comboUpgradeButton"><i class="fas fa-stopwatch"></i> Add 3 Seconds to Combo Duration (300 coins)</button>
        <button id="unlockRainbowApplesButton"><i class="fas fa-apple-alt"></i> Unlock Rainbow Apples (200 coins)</button>
        <button id="limitlessComboButton"><i class="fas fa-infinity"></i> Limitless Combo (100,000 coins)</button>
        <button id="tripleScoreButton"><i class="fas fa-star"></i> 3x Score (700 coins)</button>
    </div>
    <div id="scoreShop">
        <button id="backToMenuFromScoreShopButton"><i class="fas fa-arrow-left"></i> Back to Menu</button>
        <p>Score Shop</p>
        <p>Coins: <span id="scoreShopCoinCount">0</span></p>
        <button id="increaseRainbowApplesButton" disabled><i class="fas fa-apple-alt"></i> Increase Rainbow Apple Odds (100 coins)</button>
    </div>
    <div id="inventory" style="display: none;"> <!-- New Inventory Section -->
        <button id="backToMenuFromInventoryButton"><i class="fas fa-arrow-left"></i> Back to Menu</button>
        <p>Inventory</p>
        <p>Normal Apples: <span id="normalApplesCount">0</span></p>
        <p>Mega Apples: <span id="megaApplesCount">0</span></p>
        <p>Golden Apples: <span id="goldenApplesCount">0</span></p>
        <p>Rainbow Apples: <span id="rainbowApplesCount">0</span></p>
    </div>
    <div id="settings">
        <button id="backToMenuFromSettingsButton"><i class="fas fa-arrow-left"></i> Back to Menu</button>
        <button id="toggleDarkModeButton" class="enabled"><i class="fas fa-adjust"></i> Toggle Dark/Light Mode</button>
        <button id="toggleSoundEffectsButton" class="enabled"><i class="fas fa-volume-up"></i> Toggle Sound Effects</button>
        <button id="toggleMusicButton" class="enabled"><i class="fas fa-music"></i> Toggle Music</button>
    </div>
    <audio id="deathSound" src="https://github.com/FearOfPixelation/SnakeGame/raw/main/Predator_Jumped_by_Redacted%20(1).mp3"></audio>
    <audio id="eatSound" src="https://github.com/FearOfPixelation/SnakeGame/raw/main/coin_cropped.mp3"></audio>
    <audio id="eatRainbowSound" src="https://github.com/FearOfPixelation/SnakeGame/raw/main/coinbig_cropped.mp3"></audio>
    <audio id="backgroundMusic" src="https://github.com/FearOfPixelation/SnakeGame/raw/main/Mechanical_Madness_Boss1%20(1).mp3" loop></audio>
    <script>
        const body = document.getElementById("body");
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const deathSound = document.getElementById("deathSound");
        const eatSound = document.getElementById("eatSound");
        const eatRainbowSound = document.getElementById("eatRainbowSound");
        const backgroundMusic = document.getElementById("backgroundMusic");
        const retryButton = document.getElementById("retryButton");
        const shopButton = document.getElementById("shopButton");
        const advancedShopButton = document.getElementById("advancedShopButton");
        const scoreShopButton = document.getElementById("scoreShopButton");
        const rebirthButton = document.getElementById("rebirthButton");
        const settingsButton = document.getElementById("settingsButton");
        const backToMenuButton = document.getElementById("backToMenuButton");
        const backToMenuFromSettingsButton = document.getElementById("backToMenuFromSettingsButton");
        const backToMenuFromAdvancedShopButton = document.getElementById("backToMenuFromAdvancedShopButton");
        const backToMenuFromScoreShopButton = document.getElementById("backToMenuFromScoreShopButton");
        const toggleDarkModeButton = document.getElementById("toggleDarkModeButton");
        const toggleSoundEffectsButton = document.getElementById("toggleSoundEffectsButton");
        const toggleMusicButton = document.getElementById("toggleMusicButton");
        const slowDownButton = document.getElementById("slowDownButton");
        const biggerMenuButton = document.getElementById("biggerMenuButton");
        const doubleCoinsButton = document.getElementById("doubleCoinsButton");
        const doubleScoreButton = document.getElementById("doubleScoreButton");
        const comboMultiplierButton = document.getElementById("comboMultiplierButton");
        const megaAppleButton = document.getElementById("megaAppleButton");
        const extraBiggerMenuButton = document.getElementById("extraBiggerMenuButton");
        const reduceCooldownButton = document.getElementById("reduceCooldownButton");
        const extraCoinMultiplierButton = document.getElementById("extraCoinMultiplierButton");
        const goldenAppleOddsButton = document.getElementById("goldenAppleOddsButton");
        const sprintButton = document.getElementById("sprintButton");
        const comboUpgradeButton = document.getElementById("comboUpgradeButton");
        const unlockRainbowApplesButton = document.getElementById("unlockRainbowApplesButton");
        const increaseRainbowApplesButton = document.getElementById("increaseRainbowApplesButton");
        const tripleScoreButton = document.getElementById("tripleScoreButton");
        const limitlessComboButton = document.getElementById("limitlessComboButton");
        const coinCountDisplay = document.getElementById("coinCount");
        const advancedCoinCountDisplay = document.getElementById("advancedCoinCount");
        const scoreShopCoinCountDisplay = document.getElementById("scoreShopCoinCount");
        const highScoreDisplay = document.getElementById("highScoreDisplay");
        const multiplierValue = document.getElementById("multiplierValue");
        const scoreCoinMultiplierValue = document.getElementById("scoreCoinMultiplierValue");
        const comboMultiplierValue = document.getElementById("comboMultiplierValue");
        const comboCountdownValue = document.getElementById("comboCountdownValue");
        const sizeValue = document.getElementById("sizeValue");
        const highSizeValue = document.getElementById("highSizeValue");
        const scoreDisplay = document.getElementById("scoreDisplay");
        const coinsDisplay = document.getElementById("coinsDisplay");
        const biggerMenuCountDisplay = document.getElementById("biggerMenuCount");
        const extraBiggerMenuCountDisplay = document.getElementById("extraBiggerMenuCount");
        const megaAppleCountDisplay = document.getElementById("megaAppleCount");
        const goldenAppleCountDisplay = document.getElementById("goldenAppleCount");
        const popup = document.getElementById("popup");
        const popupText = document.getElementById("popupText");
        const popupOkButton = document.getElementById("popupOkButton");
        const rebirthPopup = document.getElementById("rebirthPopup");
        const rebirthPopupOkButton = document.getElementById("rebirthPopupOkButton");
        const coinEditor = document.getElementById("coinEditor");
        const coinInput = document.getElementById("coinInput");
        const setCoinsButton = document.getElementById("setCoinsButton");
        const toggleInvincibilityButton = document.getElementById("toggleInvincibilityButton");
        const increaseSpeedButton = document.getElementById("increaseSpeedButton");

        const gridSize = 20;
        let tileCountX = canvas.width / gridSize;
        let tileCountY = canvas.height / gridSize;
        let snake = [{ x: 10, y: 10 }];
        let direction = { x: 0, y: 0 };
        let lastDirection = { x: 0, y: 0 };
        let directionQueue = [];
        let apple = { x: 15, y: 15, type: "normal" };
        let score = 0;
        let highScore = 0;
        let coins = 0;
        let size = 1;
        let highSize = 1;
        let baseInterval = 100;
        let gameInterval;
        let biggerMenuCount = 3;
        let extraBiggerMenuCount = 1;
        let isSlowDownEnabled = false;
        let slowDownActive = false;
        let isDoubleCoinsEnabled = false;
        let isDoubleScoreEnabled = false;
        let isTripleScoreEnabled = false;
        let isExtraCoinMultiplierEnabled = false;
        let isSprintEnabled = false;
        let sprintActive = false;
        let isComboMultiplierEnabled = false;
        let comboPurchaseCount = 0;
        let comboMultiplierCost = 75;
        let comboDuration = 2.00;
        let isComboUpgradePurchased = false;
        let isRainbowApplesUnlocked = false;
        let rainbowAppleRate = 0;
        let rainbowAppleOddsCost = [100, 200, 300];
        let rainbowAppleOddsCount = 0;
        let megaAppleCount = 0;
        let megaAppleRate = 0.025;
        let goldenAppleCount = 0;
        let goldenAppleRate = 0.005;
        let darkMode = true;
        let soundEffectsEnabled = true;
        let musicEnabled = true;
        let slowDownCooldown = false;
        let cooldownTime = 0;
        let advancedShopPurchased = false;
        let limitlessShopPurchased = false;
        let extraCoinMultiplierCount = 0;
        let extraCoinMultiplierCost = [100, 250, 300, 450, 600, 650, 750, 1000, 1250, 1500];
        let goldenAppleOddsCount = 0;
        let goldenAppleOddsCost = [100, 250, 300];
        let comboMultiplier = 1;
        let comboTimeout;
        let comboCountdown = comboDuration;
        let comboCountdownInterval;
        let keysPressed = {
            shift: false,
            q: false,
            e: false,
            up: false,
            down: false,
            left: false,
            right: false
        };
        let invincibility = false;
        let rainbowAppleColors = ["red", "orange", "yellow", "green", "blue", "indigo", "violet"];
        let rebirthCount = 0;
        let permMultiplier = 1;
        let maxComboMultiplier = 6; // Default max combo multiplier
        let normalApples = 0; // Inventory counts
        let megaApples = 0;
        let goldenApples = 0;
        let rainbowApples = 0;

        function gameLoop() {
            update();
            draw();
        }

        function update() {
            // Process the direction queue
            if (directionQueue.length > 0) {
                const newDirection = directionQueue.shift();
                if ((newDirection.x !== -lastDirection.x || newDirection.y !== -lastDirection.y) && (newDirection.x !== 0 || newDirection.y !== 0)) {
                    direction = newDirection;
                }
            }

            const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };

            if (head.x === apple.x && head.y === apple.y) {
                let baseCoinMultiplier = score >= 1000 ? 8.5 : score >= 800 ? 5 : score >= 400 ? 4 : score >= 200 ? 3 : score >= 100 ? 2.5 : score >= 70 ? 2 : score >= 40 ? 1.5 : score >= 20 ? 1.25 : 1;
                let coinMultiplier = (isDoubleCoinsEnabled ? 2 : 0) + (isExtraCoinMultiplierEnabled ? extraCoinMultiplierCount : 0) + baseCoinMultiplier;
                let scoreMultiplier = (isDoubleScoreEnabled ? 2 : 0) + (isTripleScoreEnabled ? 3 : 0) + 1;
                scoreMultiplier *= permMultiplier;

                if (apple.type === "normal") {
                    score += 1 * scoreMultiplier * comboMultiplier;
                    coins += 1 * coinMultiplier * comboMultiplier;
                    normalApples++; // Track normal apples
                    if (soundEffectsEnabled) playSound(eatSound);
                } else if (apple.type === "mega") {
                    score += 5 * scoreMultiplier * comboMultiplier;
                    coins += 10 * coinMultiplier * comboMultiplier;
                    megaApples++; // Track mega apples
                    if (soundEffectsEnabled) playSound(eatSound);
                } else if (apple.type === "golden") {
                    score += 10 * scoreMultiplier * comboMultiplier;
                    coins += 50 * coinMultiplier * comboMultiplier;
                    goldenApples++; // Track golden apples
                    if (soundEffectsEnabled) playSound(eatSound);
                } else if (apple.type === "rainbow") {
                    score += 100 * scoreMultiplier * comboMultiplier;
                    coins += 100 * coinMultiplier * comboMultiplier;
                    rainbowApples++; // Track rainbow apples
                    if (soundEffectsEnabled) playSound(eatRainbowSound);
                }
                spawnApple();
                size++;
                if (size > highSize) highSize = size;
                updateSizeDisplay();

                // Handle combo multiplier
                if (isComboMultiplierEnabled) {
                    clearTimeout(comboTimeout);
                    clearInterval(comboCountdownInterval);
                    comboMultiplier = Math.min(comboMultiplier + 1, maxComboMultiplier); // Max combo multiplier is now dynamic
                    comboCountdown = comboDuration;
                    comboCountdownInterval = setInterval(updateComboCountdown, 10);
                    comboTimeout = setTimeout(() => {
                        comboMultiplier = 1;
                        clearInterval(comboCountdownInterval);
                        comboCountdown = comboDuration;
                        updateComboCountdownDisplay();
                    }, comboDuration * 1000); // Reset combo if no apple eaten in combo duration
                }
            } else {
                snake.pop();
            }

            if (!invincibility && (head.x < 0 || head.x >= tileCountX || head.y < 0 || head.y >= tileCountY || snake.some(segment => segment.x === head.x && segment.y === head.y))) {
                clearInterval(gameInterval);
                clearInterval(comboCountdownInterval);
                if (score > highScore) {
                    highScore = score;
                    highScoreDisplay.textContent = highScore;
                }
                displayMenu();
                return;
            }

            snake.unshift(head);
            lastDirection = direction;
            updateScoreAndCoinsDisplay();
            updateMultiplierDisplay();
            updateButtonStates();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            let snakeColor = getSnakeColor(score);
            snake.forEach(segment => {
                ctx.fillStyle = snakeColor;
                ctx.fillRect(segment.x * gridSize, segment.y * gridSize, gridSize - 2, gridSize - 2);
            });

            if (apple.type === "normal") {
                ctx.fillStyle = "red";
            } else if (apple.type === "mega") {
                ctx.fillStyle = "purple";
            } else if (apple.type === "golden") {
                ctx.fillStyle = "gold";
            } else if (apple.type === "rainbow") {
                ctx.fillStyle = getRandomRainbowColor();
            }
            ctx.fillRect(apple.x * gridSize, apple.y * gridSize, gridSize - 2, gridSize - 2);

            ctx.fillStyle = darkMode ? "white" : "black";
        }

        function getRandomRainbowColor() {
            return rainbowAppleColors[Math.floor(Math.random() * rainbowAppleColors.length)];
        }

        function getSnakeColor(score) {
            if (score >= 1000000) return darkMode ? "white" : "black";
            if (score >= 100000) return "purple";
            if (score >= 50000) return "pink";
            if (score >= 30000) return "brown";
            if (score >= 12500) return "black";
            if (score >= 10000) return "gray";
            if (score >= 7500) return "blue";
            if (score >= 5000) return "orange";
            if (score >= 1500) return "yellow";
            if (score >= 1000) return darkMode ? "white" : "black";
            if (score >= 800) return darkMode ? "white" : "black";
            if (score >= 400) return darkMode ? "white" : "black";
            if (score >= 200) return darkMode ? "white" : "black";
            if (score >= 100) return darkMode ? "white" : "black";
            if (score >= 70) return darkMode ? "white" : "black";
            if (score >= 40) return "orange";
            if (score >= 20) return "blue";
            return "green";
        }

        function changeDirection() {
            const newDirection = { ...direction };

            if (keysPressed.up && lastDirection.y === 0) {
                newDirection.x = 0;
                newDirection.y = -1;
            } else if (keysPressed.down && lastDirection.y === 0) {
                newDirection.x = 0;
                newDirection.y = 1;
            } else if (keysPressed.left && lastDirection.x === 0) {
                newDirection.x = -1;
                newDirection.y = 0;
            } else if (keysPressed.right && lastDirection.x === 0) {
                newDirection.x = 1;
                newDirection.y = 0;
            }

            // Push the new direction to the queue
            if (newDirection.x !== direction.x || newDirection.y !== direction.y) {
                directionQueue.push(newDirection);
            }
        }

        function stopSprint(event) {
            if ((event.key === "x" || event.key === "X") && sprintActive) {
                sprintActive = false;
                clearInterval(gameInterval);
                gameInterval = setInterval(gameLoop, baseInterval);
            }
            delete keysPressed[event.key];
        }

        function resetGame() {
            snake = [{ x: 10, y: 10 }];
            direction = { x: 0, y: 0 };
            lastDirection = { x: 0, y: 0 };
            directionQueue = [];
            spawnApple();
            score = 0;
            comboMultiplier = 1;
            comboCountdown = comboDuration;
            size = 1;
            updateComboCountdownDisplay();
            updateMultiplierDisplay(); // Update multiplier before the game starts
            updateScoreAndCoinsDisplay(); // Update score and coins before the game starts
            updateSizeDisplay();
            clearInterval(gameInterval);  // Clear any existing intervals
            clearInterval(comboCountdownInterval); // Clear the combo countdown interval
            gameInterval = setInterval(gameLoop, baseInterval);
            // Start background music
            if (musicEnabled) {
                backgroundMusic.play().catch(error => {
                    console.log("Music autoplay prevented. Waiting for user interaction to start.", error);
                });
            }
            scoreCoinsDisplay.style.display = 'block'; // Show the score and coins display
            updateButtonStates(); // Update button states when the game resets
            updateStatsRegularly(); // Update stats every few seconds
        }

        function spawnApple() {
            const rand = Math.random();
            if (rand < rainbowAppleRate) {
                apple = { x: Math.floor(Math.random() * tileCountX), y: Math.floor(Math.random() * tileCountY), type: "rainbow" };
            } else if (rand < goldenAppleRate + rainbowAppleRate) {
                apple = { x: Math.floor(Math.random() * tileCountX), y: Math.floor(Math.random() * tileCountY), type: "golden" };
            } else if (rand < megaAppleRate + goldenAppleRate + rainbowAppleRate) {
                apple = { x: Math.floor(Math.random() * tileCountX), y: Math.floor(Math.random() * tileCountY), type: "mega" };
            } else {
                apple = { x: Math.floor(Math.random() * tileCountX), y: Math.floor(Math.random() * tileCountY), type: "normal" };
            }
        }

        function displayMenu() {
            menu.style.display = 'flex';
            skillTree.style.display = 'none';
            settings.style.display = 'none';
            advancedShop.style.display = 'none';
            scoreShop.style.display = 'none';
            inventory.style.display = 'none';
            canvas.style.display = 'none';
            updateCoinCount();
            updateMultiplierDisplay(); // Update multiplier after the game ends
            scoreCoinsDisplay.style.display = 'none'; // Hide the score and coins display
        }

        function hideMenu() {
            menu.style.display = 'none';
            skillTree.style.display = 'none';
            settings.style.display = 'none';
            advancedShop.style.display = 'none';
            scoreShop.style.display = 'none';
            inventory.style.display = 'none';
            canvas.style.display = 'block';
        }

        function displaySkillTree() {
            skillTree.style.display = 'flex';
            menu.style.display = 'none';
            updateCoinCount();
            updateButtonStates();
        }

        function displaySettings() {
            settings.style.display = 'flex';
            menu.style.display = 'none';
        }

        function displayAdvancedShop() {
            if (!advancedShopPurchased && coins >= 500) {
                coins -= 500;
                advancedShopPurchased = true;
                updateCoinCount();
                advancedShopButton.textContent = "Advanced Shop";
            }
            if (advancedShopPurchased) {
                advancedShop.style.display = 'flex';
                menu.style.display = 'none';
            } else {
                alert("Not enough coins to access the Advanced Shop!");
            }
            updateButtonStates();
        }

        function displayScoreShop() {
            if (score >= 100) {
                scoreShop.style.display = 'flex';
                menu.style.display = 'none';
                scoreShopCoinCountDisplay.textContent = coins;
            } else {
                alert("Score at least 100 to access the Score Shop!");
            }
        }

        function displayInventory() {
            inventory.style.display = 'flex';
            menu.style.display = 'none';
            document.getElementById('normalApplesCount').textContent = normalApples;
            document.getElementById('megaApplesCount').textContent = megaApples;
            document.getElementById('goldenApplesCount').textContent = goldenApples;
            document.getElementById('rainbowApplesCount').textContent = rainbowApples;
        }

        function toggleDarkMode() {
            darkMode = !darkMode;
            body.style.backgroundColor = darkMode ? "#121212" : "#f0f0f0";
            body.style.color = darkMode ? "#ffffff" : "#000000";
            canvas.style.borderColor = darkMode ? "#ffffff" : "#000000";
            popup.style.color = darkMode ? "white" : "black"; // Fix popup text color
            popup.style.backgroundColor = darkMode ? "black" : "white"; // Fix popup background color
            scoreCoinsDisplay.style.color = darkMode ? "#ffffff" : "#000000"; // Fix score and coins text color
            cooldownDisplay.style.color = darkMode ? "#ffffff" : "#000000"; // Fix debug text color
        }

        function toggleSoundEffects() {
            soundEffectsEnabled = !soundEffectsEnabled;
            toggleSoundEffectsButton.className = soundEffectsEnabled ? "enabled" : "disabled";
        }

        function toggleMusic() {
            musicEnabled = !musicEnabled;
            toggleMusicButton.className = musicEnabled ? "enabled" : "disabled";
            if (musicEnabled) {
                backgroundMusic.play();
            } else {
                backgroundMusic.pause();
            }
        }

        function playSound(sound) {
            sound.currentTime = 0;
            sound.play();
        }

        function updateComboCountdown() {
            comboCountdown -= 0.01;
            if (comboCountdown <= 0) {
                comboMultiplier = 1;
                comboCountdown = comboDuration;
                clearInterval(comboCountdownInterval);
            }
            updateComboCountdownDisplay();
        }

        function updateComboCountdownDisplay() {
            comboCountdownValue.textContent = comboCountdown.toFixed(2);
        }

        function updateMultiplierDisplay() {
            let baseCoinMultiplier = score >= 1000 ? 8.5 : score >= 800 ? 5 : score >= 400 ? 4 : score >= 200 ? 3 : score >= 100 ? 2.5 : score >= 70 ? 2 : score >= 40 ? 1.5 : score >= 20 ? 1.25 : 1;
            let totalMultiplier = baseCoinMultiplier + (isDoubleCoinsEnabled ? 2 : 0) + (isExtraCoinMultiplierEnabled ? extraCoinMultiplierCount : 0);
            multiplierValue.textContent = totalMultiplier.toFixed(2) + 'x';
            scoreCoinMultiplierValue.textContent = baseCoinMultiplier.toFixed(2) + 'x'; // Update score coin multiplier display
            comboMultiplierValue.textContent = comboMultiplier.toFixed(2) + 'x';
        }

        function updateScoreAndCoinsDisplay() {
            scoreDisplay.textContent = score;
            coinsDisplay.textContent = coins;
            if (score >= 100) {
                scoreShopButton.style.display = 'inline-block';
            }
            if (limitlessShopPurchased) {
                rebirthButton.style.display = 'inline-block';
            }
        }

        function updateSizeDisplay() {
            sizeValue.textContent = size;
            highSizeValue.textContent = highSize;
        }

        function updateButtonStates() {
            slowDownButton.disabled = coins < 10 || isSlowDownEnabled;
            slowDownButton.className = slowDownButton.disabled ? "disabled" : "";

            biggerMenuButton.disabled = coins < 50 || biggerMenuCount <= 0;
            biggerMenuButton.className = biggerMenuButton.disabled ? "disabled" : "";

            doubleCoinsButton.disabled = coins < 100 || isDoubleCoinsEnabled;
            doubleCoinsButton.className = doubleCoinsButton.disabled ? "disabled" : "";

            doubleScoreButton.disabled = coins < 100 || isDoubleScoreEnabled;
            doubleScoreButton.className = doubleScoreButton.disabled ? "disabled" : "";

            comboMultiplierButton.disabled = coins < comboMultiplierCost || comboPurchaseCount >= 3;
            comboMultiplierButton.className = comboMultiplierButton.disabled ? "disabled" : "";

            megaAppleButton.disabled = coins < 50 || megaAppleCount >= 3;
            megaAppleButton.className = megaAppleButton.disabled ? "disabled" : "";

            extraBiggerMenuButton.disabled = coins < 150 || extraBiggerMenuCount <= 0;
            extraBiggerMenuButton.className = extraBiggerMenuButton.disabled ? "disabled" : "";

            reduceCooldownButton.disabled = coins < 250 || cooldownTime > 0;
            reduceCooldownButton.className = reduceCooldownButton.disabled ? "disabled" : "";

            extraCoinMultiplierButton.disabled = coins < extraCoinMultiplierCost[extraCoinMultiplierCount] || extraCoinMultiplierCount >= 10;
            extraCoinMultiplierButton.className = extraCoinMultiplierButton.disabled ? "disabled" : "";

            goldenAppleOddsButton.disabled = coins < goldenAppleOddsCost[goldenAppleOddsCount] || goldenAppleOddsCount >= 3;
            goldenAppleOddsButton.className = goldenAppleOddsButton.disabled ? "disabled" : "";

            sprintButton.disabled = coins < 250 || isSprintEnabled;
            sprintButton.className = sprintButton.disabled ? "disabled" : "";

            comboUpgradeButton.disabled = coins < 300 || isComboUpgradePurchased;
            comboUpgradeButton.className = comboUpgradeButton.disabled ? "disabled" : "";

            unlockRainbowApplesButton.disabled = coins < 200 || isRainbowApplesUnlocked;
            unlockRainbowApplesButton.className = unlockRainbowApplesButton.disabled ? "disabled" : "";

            increaseRainbowApplesButton.disabled = coins < rainbowAppleOddsCost[rainbowAppleOddsCount] || !isRainbowApplesUnlocked || rainbowAppleOddsCount >= 3;
            increaseRainbowApplesButton.className = increaseRainbowApplesButton.disabled ? "disabled" : "";

            tripleScoreButton.disabled = coins < 700 || isTripleScoreEnabled;
            tripleScoreButton.className = tripleScoreButton.disabled ? "disabled" : "";

            limitlessComboButton.disabled = coins < 100000 || limitlessShopPurchased;
            limitlessComboButton.className = limitlessComboButton.disabled ? "disabled" : "";

            rebirthButton.disabled = coins < 500000 || rebirthCount > 0;
            rebirthButton.className = rebirthButton.disabled ? "disabled" : "";

            advancedShopButton.disabled = coins < 500 && !advancedShopPurchased;
            advancedShopButton.className = advancedShopButton.disabled ? "disabled" : "";
        }

        function updateStatsRegularly() {
            setInterval(() => {
                updateMultiplierDisplay();
                updateComboCountdownDisplay();
                updateScoreAndCoinsDisplay();
                updateSizeDisplay();
                updateButtonStates();
            }, 1000);
        }

        retryButton.addEventListener("click", () => {
            resetGame();
            hideMenu();
        });

        shopButton.addEventListener("click", displaySkillTree);

        settingsButton.addEventListener("click", displaySettings);

        advancedShopButton.addEventListener("click", displayAdvancedShop);

        scoreShopButton.addEventListener("click", displayScoreShop);

        backToMenuButton.addEventListener("click", displayMenu);

        backToMenuFromSettingsButton.addEventListener("click", displayMenu);

        backToMenuFromAdvancedShopButton.addEventListener("click", displayMenu);

        backToMenuFromScoreShopButton.addEventListener("click", displayMenu);

        backToMenuFromInventoryButton.addEventListener("click", displayMenu);

        inventoryButton.addEventListener("click", displayInventory);

        toggleDarkModeButton.addEventListener("click", toggleDarkMode);

        toggleSoundEffectsButton.addEventListener("click", toggleSoundEffects);

        toggleMusicButton.addEventListener("click", toggleMusic);

        slowDownButton.addEventListener("click", () => {
            if (coins >= 10) {
                coins -= 10;
                isSlowDownEnabled = true;
                slowDownButton.disabled = true;
                updateCoinCount();
                showPopup("Hold the Z button to slow down (only works up to 5 seconds)");
            }
        });

        biggerMenuButton.addEventListener("click", () => {
            if (coins >= 50 && biggerMenuCount > 0) {
                coins -= 50;
                biggerMenuCount--;
                canvas.width += 100;
                canvas.height += 100;
                tileCountX = canvas.width / gridSize;
                tileCountY = canvas.height / gridSize;
                updateCoinCount();
                biggerMenuCountDisplay.textContent = biggerMenuCount;
                if (biggerMenuCount === 0) {
                    biggerMenuButton.disabled = true;
                }
            }
        });

        extraBiggerMenuButton.addEventListener("click", () => {
            if (coins >= 150 && extraBiggerMenuCount > 0) {
                coins -= 150;
                extraBiggerMenuCount--;
                canvas.width += 100;
                canvas.height += 100;
                tileCountX = canvas.width / gridSize;
                tileCountY = canvas.height / gridSize;
                updateCoinCount();
                extraBiggerMenuCountDisplay.textContent = extraBiggerMenuCount;
                if (extraBiggerMenuCount === 0) {
                    extraBiggerMenuButton.disabled = true;
                }
            }
        });

        doubleCoinsButton.addEventListener("click", () => {
            if (coins >= 100) {
                coins -= 100;
                isDoubleCoinsEnabled = true;
                doubleCoinsButton.disabled = true;
                updateCoinCount();
            }
        });

        doubleScoreButton.addEventListener("click", () => {
            if (coins >= 100) {
                coins -= 100;
                isDoubleScoreEnabled = true;
                doubleScoreButton.disabled = true;
                updateCoinCount();
            }
        });

        comboMultiplierButton.addEventListener("click", () => {
            if (coins >= comboMultiplierCost && comboPurchaseCount < 3) {
                coins -= comboMultiplierCost;
                comboMultiplierCost += 50;
                comboPurchaseCount++;
                isComboMultiplierEnabled = true;
                if (comboPurchaseCount === 1) {
                    comboMultiplierButton.textContent = "Increase Combo Duration (Next Cost: " + comboMultiplierCost + " coins)";
                    comboMultiplierDisplay.style.display = "block";
                    comboCountdownDisplay.style.display = "block";
                } else if (comboPurchaseCount === 2) {
                    comboDuration += 1;
                    comboMultiplierButton.textContent = "Increase Combo Duration (Next Cost: " + comboMultiplierCost + " coins)";
                } else if (comboPurchaseCount === 3) {
                    comboDuration += 1;
                    comboMultiplierButton.disabled = true;
                    comboMultiplierButton.textContent = "Max Combo Multiplier";
                }
                updateCoinCount();
            }
        });

        comboUpgradeButton.addEventListener("click", () => {
            if (coins >= 300) {
                coins -= 300;
                comboDuration += 3;
                isComboUpgradePurchased = true;
                comboUpgradeButton.disabled = true;
                comboUpgradeButton.textContent = "Combo Duration Upgraded";
                updateCoinCount();
            }
        });

        unlockRainbowApplesButton.addEventListener("click", () => {
            if (coins >= 200) {
                coins -= 200;
                isRainbowApplesUnlocked = true;
                unlockRainbowApplesButton.disabled = true;
                unlockRainbowApplesButton.textContent = "Rainbow Apples Unlocked";
                updateCoinCount();
            }
        });

        increaseRainbowApplesButton.addEventListener("click", () => {
            if (coins >= rainbowAppleOddsCost[rainbowAppleOddsCount] && rainbowAppleOddsCount < 3 && isRainbowApplesUnlocked) {
                coins -= rainbowAppleOddsCost[rainbowAppleOddsCount];
                rainbowAppleOddsCount++;
                rainbowAppleRate = rainbowAppleOddsCount === 1 ? 0.015 : rainbowAppleOddsCount === 2 ? 0.03 : 0.045;
                updateCoinCount();
                if (rainbowAppleOddsCount < 3) {
                    increaseRainbowApplesButton.textContent = "Increase Rainbow Apple Odds (Next Cost: " + rainbowAppleOddsCost[rainbowAppleOddsCount] + " coins)";
                } else {
                    increaseRainbowApplesButton.disabled = true;
                    increaseRainbowApplesButton.textContent = "Max Rainbow Apple Odds";
                }
            }
        });

        tripleScoreButton.addEventListener("click", () => {
            if (coins >= 700) {
                coins -= 700;
                isTripleScoreEnabled = true;
                tripleScoreButton.disabled = true;
                updateCoinCount();
            }
        });

        megaAppleButton.addEventListener("click", () => {
            if (coins >= 50 && megaAppleCount < 3) {
                coins -= 50;
                megaAppleCount++;
                megaAppleRate = megaAppleCount === 1 ? 0.075 : megaAppleCount === 2 ? 0.1 : 0.125;
                goldenAppleRate = megaAppleCount === 1 ? 0.005 : megaAppleCount === 2 ? 0.01 : 0.015;
                updateCoinCount();
                megaAppleCountDisplay.textContent = 3 - megaAppleCount;
                if (megaAppleCount === 3) {
                    megaAppleButton.disabled = true;
                }
            }
        });

        reduceCooldownButton.addEventListener("click", () => {
            if (coins >= 250) {
                coins -= 250;
                cooldownTime = 10000; // 10 seconds cooldown
                reduceCooldownButton.disabled = true;
                updateCoinCount();
            }
        });

        extraCoinMultiplierButton.addEventListener("click", () => {
            if (coins >= extraCoinMultiplierCost[extraCoinMultiplierCount] && extraCoinMultiplierCount < 10) {
                coins -= extraCoinMultiplierCost[extraCoinMultiplierCount];
                extraCoinMultiplierCount++;
                isExtraCoinMultiplierEnabled = true;
                if (extraCoinMultiplierCount < 10) {
                    extraCoinMultiplierButton.textContent = "+1x Multiplier (Next Cost: " + extraCoinMultiplierCost[extraCoinMultiplierCount] + " coins)";
                } else {
                    extraCoinMultiplierButton.disabled = true;
                    extraCoinMultiplierButton.textContent = "Max +1x Multiplier";
                }
                updateCoinCount();
                updateMultiplierDisplay();
            }
        });

        goldenAppleOddsButton.addEventListener("click", () => {
            if (coins >= goldenAppleOddsCost[goldenAppleOddsCount] && goldenAppleOddsCount < 3) {
                coins -= goldenAppleOddsCost[goldenAppleOddsCount];
                goldenAppleOddsCount++;
                goldenAppleRate = goldenAppleCount === 1 ? 0.005 : goldenAppleCount === 2 ? 0.01 : 0.015;
                updateCoinCount();
                if (goldenAppleOddsCount < 3) {
                    goldenAppleOddsButton.textContent = "Increase Golden Apple Odds (Next Cost: " + goldenAppleOddsCost[goldenAppleOddsCount] + " coins)";
                } else {
                    goldenAppleOddsButton.disabled = true;
                    goldenAppleOddsButton.textContent = "Max Golden Apple Odds";
                }
            }
        });

        sprintButton.addEventListener("click", () => {
            if (coins >= 250) {
                coins -= 250;
                isSprintEnabled = true;
                sprintButton.disabled = true;
                updateCoinCount();
                showPopup("Click the X key to sprint");
            }
        });

        limitlessComboButton.addEventListener("click", () => {
            if (coins >= 100000) {
                coins -= 100000;
                limitlessShopPurchased = true;
                maxComboMultiplier = 60; // Increase combo multiplier limit to 60x
                limitlessComboButton.disabled = true;
                rebirthButton.style.display = 'inline-block';
                updateCoinCount();
            }
        });

        rebirthButton.addEventListener("click", () => {
            if (coins >= 500000 && rebirthCount === 0) {
                coins = 0;
                isSlowDownEnabled = false;
                isDoubleCoinsEnabled = false;
                isDoubleScoreEnabled = false;
                isTripleScoreEnabled = false;
                isExtraCoinMultiplierEnabled = false;
                isSprintEnabled = false;
                isComboMultiplierEnabled = false;
                isComboUpgradePurchased = false;
                isRainbowApplesUnlocked = false;
                rainbowAppleRate = 0;
                megaAppleRate = 0.025;
                goldenAppleRate = 0.005;
                comboPurchaseCount = 0;
                extraCoinMultiplierCount = 0;
                goldenAppleOddsCount = 0;
                comboMultiplierCost = 75;
                maxComboMultiplier = 6;
                advancedShopPurchased = false;
                limitlessShopPurchased = false;

                // Reset all button states
                biggerMenuCount = 3;
                extraBiggerMenuCount = 1;
                biggerMenuButton.disabled = false;
                extraBiggerMenuButton.disabled = false;
                biggerMenuButton.textContent = "Buy Bigger Menu (50 coins) - Remaining: " + biggerMenuCount;
                extraBiggerMenuButton.textContent = "Buy Extra Bigger Menu (150 coins)";
                
                doubleCoinsButton.disabled = false;
                doubleCoinsButton.textContent = "Buy Double Coins (100 coins)";
                
                doubleScoreButton.disabled = false;
                doubleScoreButton.textContent = "Buy Double Score (100 coins)";
                
                comboMultiplierButton.disabled = false;
                comboMultiplierButton.textContent = "Buy Combo Multiplier (75 coins)";
                
                megaAppleButton.disabled = false;
                megaAppleButton.textContent = "Increase the odds of mega apples (50 coins) - Remaining: " + (3 - megaAppleCount);
                
                reduceCooldownButton.disabled = false;
                reduceCooldownButton.textContent = "Reduce Cooldown (250 coins)";
                
                extraCoinMultiplierButton.disabled = false;
                extraCoinMultiplierButton.textContent = "+1x Multiplier (Next Cost: 100 coins)";
                
                goldenAppleOddsButton.disabled = false;
                goldenAppleOddsButton.textContent = "Increase Golden Apple Odds (Next Cost: 100 coins)";
                
                sprintButton.disabled = false;
                sprintButton.textContent = "Buy Sprint Ability (250 coins)";
                
                comboUpgradeButton.disabled = false;
                comboUpgradeButton.textContent = "Add 3 Seconds to Combo Duration (300 coins)";
                
                unlockRainbowApplesButton.disabled = false;
                unlockRainbowApplesButton.textContent = "Unlock Rainbow Apples (200 coins)";
                
                increaseRainbowApplesButton.disabled = false;
                increaseRainbowApplesButton.textContent = "Increase Rainbow Apple Odds (Next Cost: 100 coins)";
                
                tripleScoreButton.disabled = false;
                tripleScoreButton.textContent = "3x Score (700 coins)";
                
                limitlessComboButton.disabled = false;
                limitlessComboButton.textContent = "Limitless Combo (100,000 coins)";
                
                rebirthButton.disabled = true;
                rebirthButton.style.display = 'none';

                // Show the inventory button after the first rebirth
                inventoryButton.style.display = 'inline-block';

                updateButtonStates();
                updateCoinCount();
                
                rebirthCount++;
                showRebirthPopup();
            }
        });

        setCoinsButton.addEventListener("click", () => {
            coins = parseInt(coinInput.value, 10);
            updateCoinCount();
            updateButtonStates();
            coinEditor.style.display = 'none';
        });

        toggleInvincibilityButton.addEventListener("click", () => {
            invincibility = !invincibility;
            toggleInvincibilityButton.textContent = invincibility ? "Disable Invincibility" : "Enable Invincibility";
        });

        increaseSpeedButton.addEventListener("click", () => {
            baseInterval = Math.max(10, baseInterval - 10);
            clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, baseInterval);
        });

        function updateCoinCount() {
            coinCountDisplay.textContent = coins;
            advancedCoinCountDisplay.textContent = coins;
            scoreShopCoinCountDisplay.textContent = coins;
            updateButtonStates();
        }

        function showPopup(message) {
            popupText.textContent = message;
            popup.style.display = "block";
        }

        function showRebirthPopup() {
            rebirthPopup.style.display = "block";
        }

        popupOkButton.addEventListener("click", () => {
            popup.style.display = "none";
        });

        rebirthPopupOkButton.addEventListener("click", () => {
            rebirthPopup.style.display = "none";
            resetGame();
            hideMenu();
        });

        document.addEventListener("keydown", (event) => {
            switch (event.key) {
                case "Shift":
                    keysPressed.shift = true;
                    break;
                case "Q":
                    if (keysPressed.shift) keysPressed.q = true;
                    break;
                case "E":
                    if (keysPressed.q) keysPressed.e = true;
                    break;
                case "ArrowUp":
                case "w":
                case "W":
                    keysPressed.up = true;
                    break;
                case "ArrowDown":
                case "s":
                case "S":
                    keysPressed.down = true;
                    break;
                case "ArrowLeft":
                case "a":
                case "A":
                    keysPressed.left = true;
                    break;
                case "ArrowRight":
                case "d":
                case "D":
                    keysPressed.right = true;
                    break;
                case "z":
                case "Z":
                    if (isSlowDownEnabled && !slowDownActive && !slowDownCooldown) {
                        slowDownActive = true;
                        clearInterval(gameInterval);
                        gameInterval = setInterval(gameLoop, baseInterval * 1.5);
                        setTimeout(() => {
                            slowDownActive = false;
                            slowDownCooldown = true;
                            cooldownTime = 20000; // 20 seconds cooldown
                            clearInterval(gameInterval);
                            gameInterval = setInterval(gameLoop, baseInterval);
                            const cooldownInterval = setInterval(() => {
                                cooldownTime -= 1000;
                                if (cooldownTime <= 0) {
                                    slowDownCooldown = false;
                                    clearInterval(cooldownInterval);
                                }
                            }, 1000);
                        }, 5000); // 5 seconds duration
                    }
                    break;
                case "x":
                case "X":
                    if (isSprintEnabled) {
                        sprintActive = true;
                        clearInterval(gameInterval);
                        gameInterval = setInterval(gameLoop, baseInterval / 2);
                    }
                    break;
                case " ":
                    if (menu.style.display === "flex") {
                        resetGame();
                        hideMenu();
                    }
                    break;
            }
            if (keysPressed.shift && keysPressed.q && keysPressed.e) {
                coinEditor.style.display = 'block';
            }
            changeDirection();
        });

        document.addEventListener("keyup", (event) => {
            switch (event.key) {
                case "Shift":
                    keysPressed.shift = false;
                    keysPressed.q = false;
                    keysPressed.e = false;
                    break;
                case "Q":
                    keysPressed.q = false;
                    break;
                case "E":
                    keysPressed.e = false;
                    break;
                case "ArrowUp":
                case "w":
                case "W":
                    keysPressed.up = false;
                    break;
                case "ArrowDown":
                case "s":
                case "S":
                    keysPressed.down = false;
                    break;
                case "ArrowLeft":
                case "a":
                case "A":
                    keysPressed.left = false;
                    break;
                case "ArrowRight":
                case "d":
                case "D":
                    keysPressed.right = false;
                    break;
                case "x":
                case "X":
                    stopSprint(event);
                    break;
            }
            changeDirection();
        });

        // Start background music when the document is loaded
        document.addEventListener("DOMContentLoaded", () => {
            if (musicEnabled) {
                backgroundMusic.play().catch(error => {
                    console.log("Music autoplay prevented. Waiting for user interaction to start.", error);
                });
            }
        });

        canvas.addEventListener("touchstart", handleTouch, false);
        canvas.addEventListener("touchmove", handleTouch, false);

        function handleTouch(event) {
            const touch = event.touches[0];
            const rect = canvas.getBoundingClientRect();
            const touchX = touch.clientX - rect.left;
            const touchY = touch.clientY - rect.top;

            const snakeHead = snake[0];
            const headX = snakeHead.x * gridSize + gridSize / 2;
            const headY = snakeHead.y * gridSize + gridSize / 2;

            const dx = touchX - headX;
            const dy = touchY - headY;

            if (Math.abs(dx) > Math.abs(dy)) {
                if (dx > 0 && direction.x === 0) {
                    direction = { x: 1, y: 0 };
                } else if (dx < 0 && direction.x === 0) {
                    direction = { x: -1, y: 0 };
                }
            } else {
                if (dy > 0 && direction.y === 0) {
                    direction = { x: 0, y: 1 };
                } else if (dy < 0 && direction.y === 0) {
                    direction = { x: 0, y: -1 };
                }
            }

            if (snake.length > 1 && direction.x === -snake[1].x && direction.y === -snake[1].y) {
                return;
            }

            event.preventDefault();
        }

        resetGame();
    </script>
</body>
</html>
